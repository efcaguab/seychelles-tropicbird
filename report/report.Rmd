---
title: "Aldabra Tropicbird monitoring"
author: "Fernando Cagua"
date: "30 June 2016"
output: html_document
bibliography: references.bib
---

```{r read clean data, include = F}
library(magrittr)
library(ggplot2)
library(mgcv)
tb <- readRDS("../data/processed/tropicbird_monitoring.rds")
islets <- readRDS("../data/processed/islets.rds")
fix_p <- function(x, d = 2){
  if(x < 0.001) return("< 0.001")
  else return(round(x, digits = d))
}
```

# Summary

Aldabra supports the largest breeding populations of red-tailed (*Phaethon rubricauda*) and white-tailed tropicbird (*Phaethon lepturus*; WT) in Seychelles. These two species nest predominantly on islets in Passe Femme, south of Picard. Here we analyse 7 years of nesting monitoring data to in order to establish baselines to enable the comparison of future management interventions. We found that both the number of nests established by *P. lepturus*, and their success rate have been stable over the study period. Contrastingly the there has been a marked reduction on the number of nests established by *P. rubricauda*. This reduction is aggravated by relative low levels of nesting success after 2013.

# Key findings

* In average, Red tail tropicbird (_Phaethon rubricauda_; RT) nests are approximately twice as abundant than White tail tropicbird (_Phaethon lepturus_; WT) nests. The abundance of RT nests, however, shows a negative trend and has been in constant decline since 2010. Contrastingly the abundance of WT nests has been stable and does not show any significant temporal trend. 

* WT nesting is aperiodic and tends to be constant across the year. Contrastingly, RT nesting peaks tend to occur every year between November and February. Nevertheless, this periodicity has been unidentifiable since late 2014. It is possible that this is, at least in part, caused by the observed decline in nesting activity.

* Both species seem to roughly use the same islets for nest establishment.

* A nest is considered successful if the chick can be assumed to have fledged. In average, for both species, 15% of nests were successful with most of the unsuccessful nests (70-75%) failing before hatching occurred.

* While rates for WT have been stable over the study period, the success rate for RT has changed markedly over time. The highest rates correspond to peaks reached during early 2010 and 2012, when 30-40% of established nests were successful. For most other years, the success rate varies between 5 and 10%. Based on this data alone, it is not possible to determine whether 2010 and 2012 are the norm, and therefore the low success rates observed between 2013 and 2016 represent a marked decline, or whether 2010 and 2012 were exceptionally good years and therefore low success rates are the norm for this species in Aldabra. 

* While nesting success for WT is not significantly different among locations, it does differ for RT. Picard seem to be an important location as the nesting success rate there, especially for RT, is larger when compared to other locations. Excluding Picard, the variation on RT nesting success among islets, can be explained—to a small extent—by the islet area, with nesting success being larger in larger islets. Conversely, islet’s distance from Picard showed no effect on the success rate. 

* Overall, the available data does not offer support to the hypothesis that rats are the main driver of nest failure. This however cannot be ruled out as the interaction between nesting site quality/availability and species' preferences may affect the nests' vulnerability to rats (and other predators), and therefore explain the observed differences across locations. Temporal trends might be explained by a differential species' response to—possibly climate related—changes in food and habitat quality.

# Reccomendations

1. To continue tropicbird monitoring

2. To modify current monitoring to determine spatial and temporal trends on habitat quality, nest site availavility and nest site species' preferences.

3. To plan dedicated research effort to determine the main predators of both species' eggs and chicks and how it varies over locations and time. 

4. To investigate how current nesting success rates for *P. rubricauda* compare to other populations in the Indian Ocean and elsewhere. If they are substantialy low, management interventions that seek to reduce the number of invasive predators should be considered, even if current evidence is limited. 

# Methods

Please refer to the "Tropic Bird protocol" for details about the study site and data collection.

### Breeding seasonality

To determine the breeding periodicity (rhythmic patterns) of the focal species we used a wavelet analysis of the number of new nests per species. The wavelet decomposition identifies the dominant cycles in the time series. It quantifies the changes trough time of the power of different periods, and therefore it also allows the detection of temporal changes on the periodicity. We evaluated the significance of the results produced by the wavelet analysis by comparing them to those produced by 99 randomisations of the time series. 

Although the wavelet analysis provides an indication of the period, or duration, of the dominant cycles, it does not provide information on the timing of high and low seasons. To assess when the periods of peak and trough nesting activity occur, we used a series of generalised additive mixed effect models (GAMM) in which the response variable was, again, the total number of new nests established by each species in a monthly basis. In these models, we included *date* and *month* as smooth terms. Specifically, date was included to detect long term trends in nesting establishment, while month was included to account for the non-linear variation in nesting across the year. Finally, to account for differences in survey effort the number of surveys per month was also included as a linear predictor in these models.

Furthermore, we expect the seasonal and temporal patterns observed for nest establishment to be consistent with other indicators of nesting activity. Specifically, we examined the patterns of *(i)* the number of nests that were observed to be occupied by an egg or *(ii)* small chicks not yet feathered. These two additional variables were analysed in an identical fashion as the previously described models for nest establishment.

### Breeding success

To determine whether a nest was successful of not, we determined the stage at which it was last observed. If a nest was observed to be occupied by an egg or a partially feathered chick and it was later observed empty or with signs of predation, we assumed nesting was unsuccessful. If, conversely, a nest was observed to be occupied by a fully feathered chick and in a posterior visit the nest was found to be empty and without signs of predation, we assumed that nesting was successful and therefore fledgling was likely to have occurred (hereafter nesting success). 

We then were interested on inspecting the temporal and spatial trends of nesting success and failure. Therefore, for each species, we constructed a series of GAMMs with a binomial error structure to model the probability *(i)* of nesting success, *(ii)* that nesting failed at egg stage, or *(iii)* that nesting failed at chick stage. In these models we included *date* as a smooth term to investigate temporal trends, while *location* was included as a factor to assess potential differences among islets and Picard. Competing models were assessed by comparing their Akaike information criterion (AICc). Locations for which less than 7 nests have been ever observed (roughly one per year) were excluded from this and subsequent analysis. 

These previously described models suggested marked spatial differences on nesting success, particularly for *P. rubricauda*. Anecdotal evidence suggest that invasive rats might be a major predator of tropicbird eggs and chicks. As islets might be too small to sustain permanent rat populations, we therefore explored whether islet size, and distance from Picard (which is known to have resident rats) could explain the observed differences in nesting success. We accomplished this by including these two factors in a generalised linear model (GLM) in which the response variable was the probability of nesting success of each species. As in previous analysis, we chose the most parsimonious model by comparing their AIC. 

# Results

```{r effort and nests, message=FALSE, warning=FALSE, echo=FALSE, fig.height=1.7, fig.width=6.2}
effort <- tb$tblColEvent %>%
  dplyr::mutate(date = as.Date(Date., format = "%m/%d/%y"),
                month = lubridate::month(date), 
                year = lubridate::year(date)) %>%
  dplyr::group_by(month, year) %>%
  dplyr::summarise(n_surveys = dplyr::n_distinct(date)) %>%
  dplyr::filter(!is.na(month))

saveRDS(effort, "../data/processed/effort.rds")

all_tb <- tb$tblIsletCounts %>% 
  dplyr::inner_join(tb$tblColEvent, 
                    by = c("fkColEventID" = "pkDataColEvent")) %>%
  dplyr::inner_join(tb$tblNestCode, 
                    by = c("fkNestCode" = "pkNestCodeID")) %>%
  dplyr::mutate(date = as.Date(Date., format = "%m/%d/%y"),
                y_day = lubridate::yday(date), 
                month = lubridate::month(date), 
                year = lubridate::year(date))

saveRDS(all_tb, file = "../data/processed/basic-data.rds")

# new nest
new_nest <- all_tb %>%
  dplyr::filter(NewExisting == "New") %>%
  dplyr::group_by(fkSppId, month, year) %>%
  dplyr::summarise(n_new_nest = n(), 
                   date = mean(date)) %>%
  dplyr::inner_join(tb$tblSpp, 
                    by = c("fkSppId" = "ID")) %>%
  dplyr::inner_join(effort) %>%
  dplyr::mutate(n_new_nest_corr = n_new_nest/n_surveys)
```

Surveys were consistently performed between `r min(all_tb$date) %>% format("%e %B %Y")` and `r max(all_tb$date) %>% format("%e %B %Y")` (Figure S1). In total `r sum(effort$n_surveys)` surveys were performed at a mean frequency of `r round(mean(effort$n_surveys), 1)` ± `r round(sd(effort$n_surveys), 1)` (mean ± standard deviation) per month. During these trips we detected a total of `r sum(dplyr::filter(new_nest, fkSppId == 1)$n_new_nest)` individual nests for *P. rubricauda* and `r sum(dplyr::filter(new_nest, fkSppId == 2)$n_new_nest)` for *P. lepturus*. Islet area ranged between `r round(min(islets@data$area))` and `r round(max(islets@data$area))` m² (mean `r round(mean(islets@data$area))` m²), while distance from Picard ranged between `r round(min(islets@data$dist_picard))` and `r round(max(islets@data$dist_picard))` m (mean `r round(mean(islets@data$dist_picard))` m).

### Breeding seasonality

```{r seasonality, echo=F, message=FALSE, warning=FALSE, results = "hide"}

new_nest_models <- plyr::dlply(new_nest, "fkSppId", function(x){
  gam(n_new_nest ~ s(month) + s(as.numeric(date)) + n_surveys, family = "poisson", data = x)
})

saveRDS(new_nest_models, file = "../data/processed/new_nest_models.rds")

model_data <- expand.grid(month = 1:12, n_surveys = mean(effort$n_surveys), date = mean(new_nest$date))

model_data <- plyr::ldply(new_nest_models, function(x){
  fit <- predict(x, newdata = model_data, type = "response", se.fit = T)
  model_data %>%
    dplyr::mutate(n_new_nest_p = fit[[1]],
                  n_new_nest_se = fit[[2]])
  }) %>%
  dplyr::inner_join(tb$tblSpp, 
                    by = c("fkSppId" = "ID"))

# eggs and chicks

eggs_chicks <- c("e", "c1")  %>%
  plyr::ldply(function(x){
    all_tb %>%
      plyr::ddply("fkSppId", function(y){
        y %>%
          dplyr::filter(as.character(NestCode) == x) %>%
          dplyr::group_by(fkSppId, month, year) %>%
          dplyr::summarise(n = n()) %>% 
          dplyr::mutate(NestCode = x) 
      })
  }) %>% dplyr::inner_join(effort)

eggs_chicks_models <- plyr::dlply(eggs_chicks, c("NestCode", "fkSppId"), function(x){
  gam(n ~ s(month) + n_surveys, family = "poisson", data = x)
  }) 

p_values <- eggs_chicks_models %>% lapply(function(x) anova(x)$s.pv)

```

The wavelet analysis indicated an overall significant periodicity on the establishment of new nests by *P. rubricauda* but not for *P. lepturus* (Figure 1). For *P. rubricauda* the dominant cycle has a period of approximately twelve months, this is, peaks on nesting activity occur once a year. Nevertheless, the intensity of this yearly cycle has been damped to the point to which there has been no significant periodicity since late 2014.

The results of the wavelet analysis were strongly supported by those of the GAMMs, which indicated a significant effect of "month"" on the number of new nests established by *P. rubricauda* (*p* `r fix_p(anova(new_nest_models[[1]])$s.pv[1])`; Figure 2A). With a peak on December and January, and a trough on June and July. As we expected, the number of nest occupied by downy chicks or eggs tracked the patterns shown by the number of established nests (Figure S2). 

Furthermore, when exploring the long term trends, we found a significant decrease in the number of new nests established by *P. rubricauda* over the monitoring period (*p* = `r fix_p(anova(new_nest_models[[1]])$s.pv[2], 3)`; Figure 2B). Contrastingly, for *P. lepturus*, neither the wavelet analysis nor the GAMMs showed evidence of a significant trend nor seasonal variation in the number of new nests nor the number of nest occupied by downy chicks or eggs (p = `r fix_p(anova(new_nest_models[[2]])$s.pv[1])`, p = `r fix_p(p_values[[2]])`, and p = `r fix_p(p_values[[4]])` respectively; Figure 2). 

```{r wavelet, message= FALSE, warning = F, echo = F, results= "hide", fig.height = 2, fig.width=7, fig.align="center", dpi = 150}
library(WaveletComp)

set.seed(2)
nest_wavelet <- new_nest %>%
  plyr::dlply("fkSppId", function(x){
    x %>%
      dplyr::arrange(year, month) %>%
      dplyr::mutate(date = paste(year, month, "01"),
                    date = as.Date(date, format = "%Y %m %d")) %>%
      dplyr::select(date, n_new_nest_corr)
  }) %>% 
  lapply(analyze.wavelet, "n_new_nest_corr", loess.span = 0, n.sim = 100, verbose = F)

as.df <- function(x, y){
  x %>%
  `row.names<-`(y$Period) %>%
  `colnames<-`(as.character(y$series$date)) %>%
  as.data.frame.table() %>%
  dplyr::mutate(y = log10(as.numeric(as.character(Var1))),
                x = as.numeric(Var2))
} 


p <- plyr::llply(nest_wavelet, function(x){
  d <- x$series$date
  
  conf <- dplyr::data_frame(u = c(0.1, unique(as.df(x$Power, x)$x), max(as.df(x$Power, x)$x) + 1), 
                            uu = rev(u)) %>%
    dplyr::rowwise() %>%
    dplyr::mutate(uu = min(u, uu) + 1, 
                  uu = log10(uu))
  
  pvalues <- (x$Power.pval >= 0.05) %>% as.df(x) %>% 
    dplyr::mutate(Freq = as.numeric(Freq))
  
  
  p1 <- as.df(x$Power, x) %>%
    ggplot(aes(x = x)) +
    geom_tile(aes(fill = Freq, y = y)) +
    # stat_contour(aes(z = Freq, y = y), colour = "black", bins = 8) +
    scale_y_continuous(expand = c(0,0), 
                       breaks = log10(c(3, 6, 12, 24, 36)), 
                       labels = c(3, 6, 12, 24, 36), 
                       limits = c(min(as.df(x$Power, x)$y), max(as.df(x$Power, x)$y))) +
    scale_x_continuous(expand = c(0,0), 
                       breaks = which(d - lubridate::round_date(d, "year") == 0),
                       labels = lubridate::year(d[d - lubridate::round_date(d, "year") == 0]), 
                       limits = c(min(as.df(x$Power, x)$x+0.5), max(as.df(x$Power, x)$x)-0.5)) +
    stat_contour(data = pvalues, aes(z = Freq, y = y, x = x), bins = 1, colour = "gray30") +
    # geom_hline(yintercept = log10(c(2, 3, 6, 12, 24)), colour = "grey20", 
               # size = 0.2, linetype = 2) +
    geom_line(data = conf, aes(x = u, y = uu), linetype = 2, alpha = 0.5) +
    scale_fill_gradient2(low = "#377eb8", high = "#e41a1c", mid = "white", midpoint =mean(x$Power)) +
    theme_bw() + 
    theme(legend.position = "none", axis.title = element_text(size = 10)) +
    ylab("period (months)") + xlab("date")
  
  p2 <- data.frame(period = unique(as.df(x$Power, x)$y), power_mean = x$Power.avg, 
                   p_value = x$Power.avg.pval) %>%
    ggplot(aes(x = period, y = power_mean)) +
    geom_line() +
    geom_point(aes(fill = p_value < 0.05), shape = 21) +
    scale_fill_manual(values = c("white", "grey20")) +
    scale_x_continuous(expand = c(0,0),
                       breaks = log10(c(2, 3, 6, 12, 24, 36)), 
                       labels = c(2, 3, 6, 12, 24, 36)) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = "none") +
    ylab("mean power") + xlab("")
  
  list(p2, p1)
})

cowplot::plot_grid(p[[1]][[2]], p[[2]][[2]], ncol = 2, labels = c("A", "B"), label_size = 10)
```

_**Figure 1:** Wavelet decomposition of the number of new nests established by (A) P. rubricauda and (B) P. lepturus for the study period. The different colours indicate how the power of a particular period (y axis) changes during the study period (x axis). Shades of red indicate a higher power relative to blue shades. Dashed lines indicate the cone of influence, above which results should not be interpreted. The black contours indicate the regions in which periodicity was significantly different from the random expectation at the 0.05 level._

```{r seasonality_new-nest-plot, fig.height=3, message=FALSE, warning=FALSE, echo=FALSE, fig.height = 6, fig.width= 3.4, fig.align="center", dpi = 150}

season_cuts <- seq(as.Date("2009-07-01"), as.Date("2016-07-01"), by = "year")

# New nests over time

model_data_new_nest <- expand.grid(n_surveys = mean(effort$n_surveys), date = seq(min(season_cuts), max(season_cuts), "month")) %>%
  dplyr::mutate(month = lubridate::month(date))

model_data_new_nest <- plyr::ldply(new_nest_models, function(x){
  fit <- predict(x, newdata = model_data_new_nest, type = "response", se.fit = T)
  model_data_new_nest %>%
    dplyr::mutate(n_new_nest_p = fit[[1]],
                  n_new_nest_se = fit[[2]])
  }) %>%
  dplyr::inner_join(tb$tblSpp, 
                    by = c("fkSppId" = "ID"))

p2 <- model_data_new_nest %>%
  dplyr::mutate(season = cut(date, season_cuts)) %>% 
  dplyr::filter(!is.na(season)) %>%
  dplyr::group_by(fkSppId, season) %>%
  dplyr::summarise(n_new_nest_p_mean = sum(n_new_nest_p),
                   n_new_nest_se_mean = sum(n_new_nest_se)) %>% 
  ggplot(aes(x = as.Date(season) + 6*30, y = n_new_nest_p_mean)) +
  geom_line(aes(colour = as.factor(fkSppId)), size = 0.2) +
  geom_point(aes(fill = as.factor(fkSppId)), shape = 21) +
  geom_ribbon(aes(ymin = n_new_nest_p_mean - n_new_nest_se_mean, 
                  ymax = n_new_nest_p_mean + n_new_nest_se_mean, 
                  fill = as.factor(fkSppId)), alpha = 0.25) +
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  scale_x_date(breaks = as.Date(c("2010-01-01", "2012-01-01", "2014-01-01", "2016-01-01")),
               labels = c("2009/10", "2011/12", "2013/14", "2015/16")) +
  # scale_y_continuous(breaks = seq(2, 11.9, 2)) +
  theme_bw() + 
  theme(legend.position = "none", 
        axis.title = element_text(size = 10)) +
  xlab("") + ylab("new nests (year)")


p1 <- new_nest %>%
  ggplot() +
  geom_boxplot(aes(x = as.factor(month), 
                   y = n_new_nest), 
               outlier.shape = 21, 
               outlier.size = 1, alpha = 0.25, colour = "grey50", size = 0.3) +
  facet_wrap(~Common.name, scales = "free_y", ncol = 1) +
  geom_line(data = model_data, 
            aes(x = month, y = n_new_nest_p, colour = Common.name)) +
  geom_ribbon(data= model_data, 
              aes(x = month, 
                  ymax = n_new_nest_p + n_new_nest_se * 1.92, 
                  ymin = n_new_nest_p - n_new_nest_se * 1.92,
                  fill = Common.name), alpha = 0.25) + 
  scale_colour_brewer(palette = "Set1") + 
  scale_fill_brewer(palette = "Set1") + 
  scale_x_discrete(labels = lubridate::month(lubridate::ymd(080101) + months(0:11), label = TRUE)) +
  scale_linetype_manual(values = c(1, 2)) + 
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 10),
        strip.background = element_rect(fill = "white", colour = "white"),
        axis.text.x = element_text(angle = 90)) +
  xlab("") + ylab("new nests (month)")

cowplot::plot_grid(p1, p2, ncol = 1, labels = c("A", "B"), label_size = 10, 
                   rel_heights = c(2,1))
```

_**Figure 2:** Number of new nests established by *P. rubricauda* (red) and *P. lepturus* (blue) a (A) monthly, and (B) yearly basis. Boxplots show the number of observed nests while lines and points depict the output of the most parsimonious models. The shaded areas indicate the corresponding standard error. All boxes cover the 25th–75th percentiles, the middle line marks the median, and the maximum length of the whiskers is 1.5 times the interquartile range. Points outside this range show up as outliers. Both the monthly and yearly trends were significant at the 0.05 level for *P. rubricauda* but not for *P. lepturus*. Results from the 2008/09 season were excluded due to incomplete sampling._

```{r seasonality_eggs-chicks, fig.height= 4, fig.width=3.4, fig.align="center", message=FALSE, warning=FALSE, echo=FALSE, dpi = 150}
saveRDS(eggs_chicks, file = "../data/processed/eggs_chicks_per_month.rds")
```


### Breeding success

```{r success, echo = F, message=F, warning = F, results = "hide"}


ext_e <- function(a){
  eggs <- which(a == "e")
  if (length(eggs)){
    if(eggs[1] == 1){
      return(1 + ext_e(a[-1]))
    } else return(eggs[1])
  } else return(NA)
}

# split stuff by new eggs or empty eggs
nest_succ <-
  all_tb %>%
  plyr::ddply(c("fkSppId" ,"fkIsletID", "NestID"), function(x){
    x %<>% dplyr::arrange(date)
    
    sequen <- x$NestCode
    nest_split <- vector("integer", length = length(sequen))
    first_egg <- ext_e(sequen)
    if (!is.na(first_egg)){
      if (first_egg != 1){
        nest_split[first_egg:length(nest_split)] <- nest_split[first_egg:length(nest_split)] + 1
      }
    }
    last_empty <- rev(which(as.character(sequen) == "en"))[1]
    if (!is.na(last_empty)){
      if (last_empty != length(sequen)){
      nest_split[(last_empty+1):length(nest_split)] <-
        nest_split[(last_empty+1):length(nest_split)] + 1
      }
    }
    x %>%
      dplyr::mutate(nest_split = nest_split)
  }, .progress = "text") 

# obtain nest succession
nest_succ <- nest_succ %>%
  plyr::ddply(c("fkSppId" ,"fkIsletID", "NestID", "nest_split"), function(x){
    nest_succession <- x %>% 
      dplyr::arrange(date) %$%
      NestCode %>% as.character()
    
    nest_succession <- nest_succession[nest_succession != dplyr::lead(nest_succession, default = "oo")] 
    
    nest_succession <- nest_succession[!nest_succession %in% c("not found", "en", "cd", "ep")]
    nest_succession_c <- nest_succession %>% paste(collapse = "-")
      
    x %>%
      dplyr::mutate(n_s = nest_succession_c, 
                    final_stage = dplyr::last(nest_succession))
  }, .progress = "text")

# determine stage
nest_succ_sum <- nest_succ %>% 
  dplyr::group_by(fkSppId, fkIsletID, NestID, nest_split) %>%
  dplyr::summarise(final_stage = unique(final_stage)) %>% 
  dplyr::group_by(fkSppId, final_stage) %>%
  dplyr::summarise(n = n())


## models
islet_info <- tb$tblIslets %>% dplyr::left_join(islets@data)

nest_succ_agg <- nest_succ %>%
  dplyr::mutate(season = cut(date, season_cuts)) %>%
  dplyr::filter(!is.na(season)) %>%
  dplyr::group_by(fkSppId, fkIsletID, NestID, nest_split) %>%
  dplyr::summarise(date = min(date), 
                   final_stage = unique(final_stage), 
                   success = final_stage == "c3",
                   failure_chi = final_stage %in% c("c1", "c2"),
                   failure_egg = final_stage == "e") %>%
  dplyr::group_by(fkIsletID, fkSppId) %>%
  dplyr::mutate(nest_islets = n()) %>%
  dplyr::group_by() %>%
  # filter out islets with not enough data
  dplyr::filter(nest_islets > 20)

nest_succ_agg %<>%
  tidyr::gather(destiny, response, success:failure_egg) %>%
  dplyr::left_join(islet_info, by = c("fkIsletID" = "pkIsletID"))


breeding_models <- 
  plyr::dlply(nest_succ_agg, 
              c("destiny", "fkSppId"), 
              function(x){
                x %<>%
                  dplyr::filter(!is.na(final_stage)) %>%
                  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                                islet = relevel(islet, "Picard"))
                mod <- tryCatch({
                  gam(response ~ s(as.numeric(date)) + islet, data= x, family = "binomial", gamma = 1.4)
                }, error = function(e){})
                if (is.null(mod)) return(NULL)
                else {
                  pred <- predict(mod, type = "response", se.fit = T)
                    pred <- x %>% dplyr::mutate(bp = pred$fit, 
                                                se = pred$se.fit, 
                                                sig = summary(mod)$s.pv[1] < 0.05)
                  return(list(mod = mod, pred = pred))
                }
              }, .inform = T) 

# concentrate on models for success and eggs

# success rubricauda
x <- nest_succ_agg %>%
  dplyr::filter(destiny == "success", 
                fkSppId == 1, 
                !is.na(final_stage))  %>%
  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                islet = relevel(islet, "Picard"))
breeding_models_s_pr_2 <- gam(response ~ s(as.numeric(date)), data= x, family = "binomial", gamma = 1.4)
breeding_models_s_pr_3 <- gam(response ~ 1, data= x, family = "binomial", gamma = 1.4)
breeding_models_s_pr_4 <- gam(response ~ islet, data= x, family = "binomial", gamma = 1.4)
new_data <- expand.grid(destiny = "success",
           fkSppId = 1, 
           islet = c("Picard", "LG17", "LG8"),
           date = seq(dplyr::first(season_cuts), dplyr::last(season_cuts), by = "30 day"))
pred <- predict(breeding_models[[1]]$mod, newdata = new_data, type = "response", se.fit = T)
sig <-  summary(breeding_models[[1]]$mod)$s.pv[1] < 0.05
pred_s_pr <- new_data %>%
  dplyr::mutate(bp = pred$fit,
                se = pred$se.fit, sig = sig) %>%
  dplyr::mutate(islet = plyr::mapvalues(islet, 
                                        c("Picard", "LG17", "LG8"),
                                        c("max", "mean", "min")))

mod_s_pr <- list(breeding_models[[1]]$mod, breeding_models_s_pr_2, breeding_models_s_pr_3, breeding_models_s_pr_4)


# success lepturus
x <- nest_succ_agg %>%
  dplyr::filter(destiny == "success", 
                fkSppId == 2, 
                !is.na(final_stage))  %>%
  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                islet = relevel(islet, "Picard"))
breeding_models_s_pl_2 <- gam(response ~ s(as.numeric(date)), data= x, family = "binomial", gamma = 1.4)
breeding_models_s_pl_3 <- gam(response ~ 1, data= x, family = "binomial", gamma = 1.4)
breeding_models_s_pl_4 <- gam(response ~ islet, data= x, family = "binomial", gamma = 1.4)
new_data <- expand.grid(destiny = "success",
           fkSppId = 2, 
           islet = c("LG13", "LG1", "LG12"),
           date = seq(dplyr::first(season_cuts), dplyr::last(season_cuts), by = "30 day"))
pred <- predict(breeding_models_s_pl_2, newdata = new_data, type = "response", se.fit = T)
pred_s_pl <- new_data %>%
  dplyr::mutate(bp = pred$fit,
                se = pred$se.fit,
                sig = summary(breeding_models_s_pl_2)$s.pv[1] < 0.05) %>%
  dplyr::mutate(islet = plyr::mapvalues(islet, 
                                        c("LG13", "LG1", "LG12"),
                                        c("max", "mean", "min")))

pred_s <- rbind(pred_s_pr, pred_s_pl)

mod_s_pl <- list(breeding_models[[2]]$mod, breeding_models_s_pl_2, breeding_models_s_pl_3, breeding_models_s_pl_4) 

# Export models
saveRDS(list(s_pr = mod_s_pr, s_pl = mod_s_pl), 
        file = "../data/processed/breeding_success_models.rds")

# egg failure rubricauda
x <- nest_succ_agg %>%
  dplyr::filter(destiny == "failure_egg", 
                fkSppId == 1, 
                !is.na(final_stage))  %>%
  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                islet = relevel(islet, "Picard"))
breeding_models_e_pr_2 <- gam(response ~ s(as.numeric(date)), data= x, family = "binomial", gamma = 1.4)
new_data <- expand.grid(destiny = "failure_egg",
           fkSppId = 1, 
           islet = c("Picard", "LG18", "LG14"),
           date = seq(dplyr::first(season_cuts), dplyr::last(season_cuts), by = "30 day"))
pred <- predict(breeding_models[[5]]$mod, newdata = new_data, type = "response", se.fit = T)
sig <- summary(breeding_models[[5]]$mod)$s.pv[1] < 0.05
pred_e_pr <- new_data %>%
  dplyr::mutate(bp = pred$fit,
                se = pred$se.fit,
                sig = sig) %>%
  dplyr::mutate(islet = plyr::mapvalues(islet, 
                                        c("Picard", "LG18", "LG14"),
                                        c("max", "mean", "min")))

# egg failure lepturus
x <- nest_succ_agg %>%
  dplyr::filter(destiny == "failure_egg", 
                fkSppId == 2, 
                !is.na(final_stage))  %>%
  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                islet = relevel(islet, "Picard"))
breeding_models_e_pl_2 <- gam(response ~ s(as.numeric(date)), data= x, family = "binomial", gamma = 1.4)
new_data <- expand.grid(destiny = "failure_egg",
           fkSppId = 2, 
           islet = c("Picard", "LG18", "LG12"),
           date = seq(dplyr::first(season_cuts), dplyr::last(season_cuts), by = "30 day"))
pred <- predict(breeding_models[[6]]$mod, newdata = new_data, type = "response", se.fit = T)
sig <- summary(breeding_models[[6]]$mod)$s.pv[1] < 0.05
pred_e_pl <- new_data %>%
  dplyr::mutate(bp = pred$fit,
                se = pred$se.fit,
                sig = sig) %>%
  dplyr::mutate(islet = plyr::mapvalues(islet, 
                                        c("Picard", "LG18", "LG12"),
                                        c("max", "mean", "min")))

breeding_models_pred <- rbind(pred_s, pred_e_pr, pred_e_pl) %>%
  dplyr::mutate(upper = plogis(qlogis(bp) + qlogis(se+0.5)),
                lower = plogis(qlogis(bp) - qlogis(se+0.5)))


#export breeding models predictions
saveRDS(breeding_models_pred, file = "../data/processed/breeding_models_predictions.rds")

# breeding_models_pred <- breeding_models %>% lapply(`[[`, 2) %>% do.call(rbind, .)
final_m_s_pr <- breeding_models[[1]]$mod
final_m_e_pr <- breeding_models_e_pr_2
final_m_s_pl <- breeding_models[[5]]$mod
final_m_e_pl <- breeding_models[[6]]$mod
  
nests_per_out <- dplyr::group_by(nest_succ_sum, final_stage, fkSppId) %>%
  dplyr::summarise(n = sum(n)) %>% 
  dplyr::group_by(fkSppId) %>%
  dplyr::mutate(p = n/sum(n)) %>%
  dplyr::filter(!is.na(final_stage))

# Individual models per islet
x <- nest_succ_agg %>%
  dplyr::filter(destiny == "success", 
                fkSppId == 1, 
                !is.na(final_stage))  

d <- data.frame(date = seq(min(season_cuts), max(season_cuts), "5 day"))

pr <- x %>%
  plyr::ddply("Name.", function(y){
    m <- gam(response ~ s(as.numeric(date)), data= y, family = "binomial", gamma = 1.4)
    p <- predict(m, newdata = d, type = "response")
    d %>% dplyr::mutate(p = p)
  }) %>%
  dplyr::mutate(ID = 1)

p_mean_pr <- d %>%
  dplyr::mutate(p = predict(breeding_models_s_pr_2, newdata = d, type = "response", se.fit = T)[[1]]) %>%
  dplyr::mutate(ID = 1)

x <- nest_succ_agg %>%
  dplyr::filter(destiny == "success", 
                fkSppId == 2, 
                !is.na(final_stage))  

pl <- x %>%
  plyr::ddply("Name.", function(y){
    m <- gam(response ~ s(as.numeric(date)), data= y, family = "binomial", gamma = 1.4)
    p <- predict(m, newdata = d, type = "response")
    d %>% dplyr::mutate(p = p)
  })  %>%
  dplyr::mutate(ID = 2)

p_mean_pl <- d %>%
  dplyr::mutate(p = predict(breeding_models_s_pl_2, newdata = d, type = "response", se.fit = T)[[1]]) %>%
  dplyr::mutate(ID = 2)
class(tb$tblSpp$ID ) <- "integer"
class(pr$ID) <- "integer"
class(pl$ID) <- "integer"
class(p_mean_pr$ID) <- "integer"
class(p_mean_pl$ID) <- "integer"
p <- rbind(pr, pl) %>% dplyr::inner_join(tb$tblSpp)
p_mean <- rbind(p_mean_pr, p_mean_pl)%>% dplyr::inner_join(tb$tblSpp)
```

```{r success periodicity, eval = F, include = F}
nest_succ_agg %>%
  dplyr::filter(destiny == "success", 
                fkSppId == 1, 
                !is.na(final_stage))  %>%
  dplyr::mutate(islet = as.factor(as.character(Name.)), 
                islet = relevel(islet, "Picard"), 
                date = cut(date, "month"), 
                date = as.Date(date)) %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(response = mean(response, na.rm = T)) %>%
  ggplot(aes(x = date, y = response)) + geom_point() + geom_line()
  # WaveletComp::analyze.wavelet("response") %>% wt.image
```

```{r success in Picard, eval = F, echo = F}


pl %>%
  ggplot() +
  geom_rect(aes(xmin = as.Date("2016-04-11")-140,
                xmax = max(season_cuts),
                ymin = 0, ymax = 1), fill = "grey90") +
  geom_rect(xmin = as.numeric(min(season_cuts)), 
            xmax = as.numeric(min(all_tb$date) + 140),
            ymin = 0, ymax = 1, fill = "grey90") +
  # geom_ribbon(data = tidyr::spread(r, Name., p), aes(x = date, ymax = Picard, ymin = LG15),
            # fill = "#e41a1c", alpha = 0.25) + 
  geom_line(aes(x = date, y = p, group = Name.), colour = "#377eb8", alpha = 0.5, size = 0.3) +
  # geom_line(data = pl[pl$Name. == "Picard", ], aes(x = date, y = p), colour = "#377eb8") + 
  # geom_line(data = pl[pl$Name. == "LG12", ], aes(x = date, y = p), colour = "#e41a1c") +
  # geom_line(data = pl[pl$Name. == "LG16", ], aes(x = date, y = p), colour = "#e41a1c", 
            # linetype = 2) + 
  geom_line(data= pred_s_pl, aes(x = date, y = bp), colour = "#377eb8", size = 1) + 
  # facet_wrap(~Name. ) + 
  theme_bw()  

```

Overall, we were able to determine the outcome for `r round(sum(dplyr::filter(nest_succ_sum, !is.na(final_stage))$n)/sum(nest_succ_sum$n) * 100)`% of the nests encountered. On average `r round(dplyr::filter(nests_per_out, final_stage == "c3")$p * 100)[1]`% of nests were successful for both species, with most of the nests failing before the egg hatched (`r round(dplyr::filter(nests_per_out, final_stage == "e")$p * 100)[1]`% for *P. rubricauda* and `r round(dplyr::filter(nests_per_out, final_stage == "e")$p * 100)[2]`% for *P.lepturus*; Figure 3A). 

Based on terms retained by the final models (selected by AICc), we found evidence suggesting that the nesting success probability for *P. rubrucauda* varies significantly across time and space (Table S1). Across time, we observed an overall downward trend on the success probability characterised by peaks during 2010 and 2012 (Figure 3B). Consistent with this decrease on nesting success, we also detected a significant increase over time on the proportion of nests that fail before the egg hatches (Figure S3). Across space, we found that the nesting success in Picard is significantly larger when compared to other locations (Box S3, Figure S4).

Contrastingly, for *P. lepturus* we did not find evidence of any significant spatial trend. Furthermore, although date was maintained in the final model and suggest a decreasing trend, its magnitude is small and cannot be distinguished from random variation in the data at the 0.05 confidence level (Figure 3B, Table S2, Box S4).

```{r per-islet-plot, eval= T, echo = F, message = F, warning = F, results = "hide", fig.width=3.4, fig.height= 2, fig.align="center", dpi = 150}

saveRDS(nest_succ_agg, 
        file = "../data/processed/nest_success_data.rds")
```


```{r sucess-plot, echo = F, message = F, warning = F, results = "hide", fig.width=3.4, fig.height= 6, fig.align="center", dpi = 150}

nest_succ_agg_season <- nest_succ_agg %>% 
  dplyr::mutate(season = cut(date, season_cuts[2:(length(season_cuts))])) %>%
  dplyr::filter(!is.na(season), !is.na(final_stage)) %>% 
  dplyr::group_by(fkSppId, season) %>%
  dplyr::summarise(n_nests = n(), 
                   c3 = mean(final_stage == "c3"),
                   e = mean(final_stage == "e"), 
                   c3_sd = sd(final_stage == "c3"),
                   e_sd = sd(final_stage == "e")) %>%
  tidyr::gather(destiny, bp, c3:e) %>%
  tidyr::gather(destiny_sd, bp_sd, c3_sd:e_sd) %>% 
	dplyr::group_by() %>%
  dplyr::mutate(destiny = factor(destiny, labels = c("nesting success", "nesting failure - egg")),
                destiny_sd = factor(destiny_sd, labels = c("nesting success", "nesting failure - egg")),
                season = as.Date(season) + 365/2 + 30,
                fkSppId = factor(fkSppId, levels = c(1,2), labels = c("Red-tail tropicbird", "White-tail tropicbird"))) %>% 
  dplyr::filter(destiny == destiny_sd)  %>%
  dplyr::mutate(upper = plogis(qlogis(bp) + qlogis(bp_sd)),
                lower = plogis(qlogis(bp) - qlogis(bp_sd)))


p2 <- p %>%
  ggplot() +
  geom_rect(aes(xmin = as.Date("2016-04-11")-140,
                xmax = max(season_cuts),
                ymin = 0, ymax = 1, alpha = 0.5), fill = "grey90", alpha = 0.5) +
  # geom_rect(xmin = as.numeric(min(season_cuts)), 
  #           xmax = as.numeric(min(all_tb$date) + 140),
  #           ymin = 0, ymax = 1, fill = "grey90", alpha = 0.5) +
  geom_line(aes(x = date, y = p, group = interaction(Name., Common.name), 
                colour = as.factor(Common.name)), alpha = 0.5, size = 0.3) +
  geom_line(data = p_mean, aes(x = date, y = p, colour = as.factor(Common.name)), size = 1) +
  facet_wrap(~Common.name, ncol = 1, scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  theme_bw()    +
  theme(legend.position = "none",
        strip.background = element_rect(fill = "white", colour = "white"),
        axis.title = element_text(size = 10)) +
  coord_cartesian(ylim = c(0,0.8)) +
  # scale_linetype_manual(values = c(2,1)) +
  xlab("") + ylab("probability")

p1 <- nest_succ %>% 
  dplyr::group_by(fkSppId, fkIsletID, NestID, nest_split) %>%
  dplyr::summarise(final_stage = unique(final_stage)) %>%
  dplyr::filter(!is.na(final_stage)) %>%
  dplyr::mutate(final_stage = factor(final_stage, levels = c("e", "c1", "c2", "c3"))) %>%
  dplyr::group_by(fkSppId, final_stage) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::group_by(fkSppId) %>%
  dplyr::mutate(prop = n/sum(n)) %>%
  dplyr::inner_join(tb$tblSpp, by = c("fkSppId" = "ID")) %>% 
  ggplot(aes(x = final_stage, fill = Common.name, y = prop)) + 
  geom_bar(aes(colour = Common.name), position = position_dodge(width = 0.85), width = 0.8, stat = "identity", alpha = 0.75) +
  theme_bw() +
  # geom_text(aes(label = n, y = prop + 0.005), 
  #           position = position_dodge(width = 0.8), hjust = 0) + 
  scale_fill_brewer(palette = "Set1", name = "") + 
  scale_colour_brewer(palette = "Set1", name = "") + 
  theme(legend.position = "none", 
        axis.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = c("nesting failure\negg", "nesting failure\ndown covered chick", "nesting failure\npartially feathered chick", "nesting success\nfully feathered chick")) +
  coord_flip() +
  ylab("proportion") + xlab("")

cowplot::plot_grid(p1, p2, labels = c("A", "B"), ncol = 1, rel_heights = c(1,2), label_size = 10)
```

_**Figure 3:** Nesting success for *P. rubricauda* (red) and *P. lepturus* (blue). (A) the overall proportion of stages for individual nests. (B) the modelled proabability of nesting success and failure (at the egg stage) over time. Solid lines indicate a significant effect at the 0.05 level._

When exploring the hypothesis that rat presence is the driver for the variability across locations we found that of the coovariates of rat presence, we only found evidence of a significant positive relationships of islet area and nesting success for *P. rubricauda* ($p = `r fix_p(anova(final_m_s_pr)$p.pv[2], d = 3)`$). The effect of this relationship was nevertheless small and correspond to a difference of 10% increase in probability between the largest and the smallest islet. In addition, we found a negative relationship between the islet distance from Picard and the probability of failure (at an egg stage, $p = `r fix_p(anova(final_m_e_pl)$p.pv[2], d = 3)`$) for *P. lepturus*. This correspond to a 27% difference between the largest and the smallest islet. We did not find a relationship between the number of nests established in an islet and the success probability. 

```{r, eval = F, echo = F, message = F, warning = F, results = "hide", fig.height=3}

breeding_models_islet <- 
  plyr::dlply(nest_succ_agg, 
              c("destiny", "fkSppId"), 
              function(x){
                x %<>%
                  dplyr::filter(!is.na(final_stage),
                                !is.na(area),
                                !is.na(dist_picard)) %>%
                  dplyr::mutate(fkIsletID = factor(fkIsletID))
                
                mods <- list()
                mods[[1]] <- glm(response ~ area + dist_picard, data= x, family = "binomial")
                mods[[2]] <- glm(response ~ area, data= x, family = "binomial")
                mods[[3]] <- glm(response ~ dist_picard, data= x, family = "binomial")
                mods[[4]] <- glm(response ~ 1, data= x, family = "binomial")
                
                best_mod <- mods[[which.min(do.call(AIC, mods)$AIC)]]
                
                new_data <- expand.grid(area = seq(min(x$area), max(x$area), 10),
                                        dist_picard = seq(min(x$dist_picard), 
                                                          max(x$dist_picard), 10))
                
                pred <- predict(best_mod, newdata = new_data, se.fit = T, type = "response")
                new_data$pred <- pred$fit
                new_data$se <- pred$se.fit
                list(mods = mods, pred = new_data, best_mod = best_mod)
                
              }, .inform = T)   

lapply(breeding_models_islet, function(x) do.call(AIC, args = x)$AIC)
lapply(breeding_models_islet, function(x) lapply(x, summary))

best_breeding_models <- list(success_pr = breeding_models_islet[[1]][[2]],
                             success_pl = breeding_models_islet[[2]][[4]],
                             failure_pr = breeding_models_islet[[5]][[4]],
                             failure_pl = breeding_models_islet[[6]][[3]])

expand.grid()
breeding_models_islet_pred <- breeding_models_islet %>% lapply(`[[`, 2) %>% do.call(rbind, .)


breeding_models_islet[1:2] %>%
  lapply(function(x) anova(x$mod, test = "Chi"))


breeding_models_islet[1:2] %>%
  lapply(function(x) summary(x$mod))

breeding_models_islet_pred %>%  
  dplyr::filter(destiny == "success") %>% 
  dplyr::group_by(fkSppId, Name.) %>%
  dplyr::summarise(bp = mean(bp), 
                   se = mean(se)) %>%
  ggplot(aes(x = Name., y = bp, colour = as.factor(fkSppId))) +
  geom_point(position = position_dodge(width = 0.5)) + 
  geom_linerange(aes(ymax = bp+se, ymin = bp-se), alpha = 0.25,
                 position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Set1") + theme_bw()



```
